<script>

    var taxableBenefitsModelIds = [
        "taxableBenefits.bereavement_allowance",
        "taxableBenefits.carer_allowance",
        "taxableBenefits.contribution_based_jobseeker_allowance",
        "taxableBenefits.contribution_based_employment_and_support_allowance",
        "taxableBenefits.incapacity_benefit"];

    var incomeDetailsAreEstimatedModelIds = [
        "incomeDetails.self_employed_profit_is_estimated",
        "incomeDetails.self_employed_loss_is_estimated"];

    var otherIncomesAreEstimatedModelIds = ["otherIncome.rental_profit_is_estimated",
        "otherIncome.rental_loss_is_estimated",
        "otherIncome.isOtherHouseholdIncomeEst"];

    var otherHouseholdIncomeModelIds = ["otherIncome.saving_investment_dividend",
        "otherIncome.pensions", "otherIncome.trusts_settlements_or_estates",
        "otherIncome.foreign_income", "otherIncome.notional_income",
        "otherIncome.profit_from_property"];

    function estimatedSeProfits() {
        return incomeDetailsAreEstimatedModelIds.some(getMapBooleanValue);
    }

    function estimatedOtherIncome() {
        return otherIncomesAreEstimatedModelIds.some(getMapBooleanValue);
    }

    function isEstimatedIncome() {
        return estimatedOtherIncome() || estimatedSeProfits();
    }

    function appendPreviousYearSuffix(modelIds) {
        return modelIds.map(id => id + PREVIOUS_YEAR_MINUS_1);
    }

    function appendPartnerPrefix(modelIds) {
        return modelIds.map(id => 'partner.' + id);
    }

    function getIncomeDetailsJson(earningsKey, companyBenefitsKey, seProfitsKey, benefitsModelIds, areEstimatedModelIds) {
        var json = {};

        var benefits = buildTotal(benefitsModelIds);
        var earnings = getMapIntValue(earningsKey);
        var companyBenefits = getMapIntValue(companyBenefitsKey);
        var seProfits = getMapIntValue(seProfitsKey);

        if (benefits + earnings + companyBenefits > 0) {
            addIfNonZero(json, "taxableBenefits", benefits);
            addIfNonZero(json, "earnings", earnings);
            addIfNonZero(json, "companyBenefits", companyBenefits);
        }

        if (seProfits > 0) {
            addProperty(json, "seProfits", seProfits);
            addProperty(json, "seProfitsEstimated", areEstimatedModelIds.some(getMapBooleanValue));
        }

        return json;
    }

    function getCertainBenefitsJson(recievedBenefitsKey, incomeSupportKey, jsaKey, esaKey, pensionCreditKey) {
        var json = {};
        var receivingBenefits = getMapBooleanValue(recievedBenefitsKey);

        if (receivingBenefits) {
            addProperty(json, "receivedBenefits", receivingBenefits);
            addProperty(json, "incomeSupport", getMapBooleanValue(incomeSupportKey));
            addProperty(json, "jsa", getMapBooleanValue(jsaKey));
            addProperty(json, "esa", getMapBooleanValue(esaKey));
            addProperty(json, "pensionCredit", getMapBooleanValue(pensionCreditKey));
        } else {
            addProperty(json, "receivedBenefits", false);
            addProperty(json, "incomeSupport", false);
            addProperty(json, "jsa", false);
            addProperty(json, "esa", false);
            addProperty(json, "pensionCredit", false);
        }

        return json;
    }

    function getOtherIncomeJson(otherIncomeIds, otherIncomeEstimatedIds) {
        var otherIncomeTotal = buildTotal(otherIncomeIds);
        if (otherIncomeTotal > 0) {
            return {
                otherHouseholdIncome: buildTotal(otherIncomeIds),
                isOtherHouseholdIncomeEst: otherIncomeEstimatedIds.some(getMapBooleanValue)
            };
        } else {
            return {};
        }
    }

    function buildSingleD1Submission() {
        return {
            renewalData: {
                incomeDetails: getIncomeDetailsJson(
                        "incomeDetails.earnings",
                        "incomeDetails.companyBenefits",
                        "incomeDetails.seProfits",
                        taxableBenefitsModelIds,
                        incomeDetailsAreEstimatedModelIds),
                certainBenefits: getCertainBenefitsJson(
                        "certainBenefits.receivedBenefits",
                        "certainBenefits.incomeSupport",
                        "certainBenefits.jsa",
                        "certainBenefits.esa",
                        "certainBenefits.pensionCredit"
                )
            },
            otherIncome: getOtherIncomeJson(otherHouseholdIncomeModelIds, otherIncomesAreEstimatedModelIds),
            hasChangeOfCircs: getMapBooleanValue("hasChangeOfCircs"),
        };
    }

    function addSingleD2Data(submission) {
        submission.renewalData.incomeDetailsPY1 = getIncomeDetailsJson(
                "incomeDetails.earnings_PY_1",
                "incomeDetails.companyBenefits_PY_1",
                "incomeDetails.seProfits_PY_1",
                appendPreviousYearSuffix(taxableBenefitsModelIds),
                appendPreviousYearSuffix(incomeDetailsAreEstimatedModelIds));

        submission.otherIncomePY1 = getOtherIncomeJson(appendPreviousYearSuffix(otherHouseholdIncomeModelIds),
                appendPreviousYearSuffix(otherIncomesAreEstimatedModelIds));

        return submission;
    }

    function addJointD1Data(submission) {
        submission.applicant2Data = {
            incomeDetails: getIncomeDetailsJson(
                    "partner.incomeDetails.earnings",
                    "partner.incomeDetails.companyBenefits",
                    "partner.incomeDetails.seProfits",
                    appendPartnerPrefix(taxableBenefitsModelIds),
                    appendPartnerPrefix(incomeDetailsAreEstimatedModelIds)),
            certainBenefits: getCertainBenefitsJson(
                    "partner.certainBenefits.receivedBenefits",
                    "partner.certainBenefits.incomeSupport",
                    "partner.certainBenefits.jsa",
                    "partner.certainBenefits.esa",
                    "partner.certainBenefits.pensionCredit"
            )
        };

        return submission;
    }

    function addJointD2Data(submission) {
        submission.applicant2Data.incomeDetailsPY1 = getIncomeDetailsJson(
                "partner.incomeDetails.earnings_PY_1",
                "partner.incomeDetails.companyBenefits_PY_1",
                "partner.incomeDetails.seProfits_PY_1",
                appendPreviousYearSuffix(appendPartnerPrefix(taxableBenefitsModelIds)),
                appendPreviousYearSuffix(appendPartnerPrefix(incomeDetailsAreEstimatedModelIds)));

        return submission;
    }

    function buildSubmission() {
        if (getRenewalType() === SINGLE_D1 || getRenewalType() === AUTO_RENEWAL) {
            return buildSingleD1Submission();
        } else if (getRenewalType() === SINGLE_D2) {
            return addSingleD2Data(buildSingleD1Submission());
        } else if (getRenewalType() === JOINT_D1) {
            return addJointD1Data(buildSingleD1Submission());
        } else if (getRenewalType() === JOINT_D2) {
            return addJointD2Data(addJointD1Data(addSingleD2Data(buildSingleD1Submission())));
        }
    }

    function buildSubmissionPostRequest() {
        var submission = buildSubmission();

        // Android callback.
        try {
            HMRCAndroid.submissionPostRequestResult(JSON.stringify(submission));
            return;
        } catch (err) {
        }

        return (JSON.stringify(submission));
    }
</script>